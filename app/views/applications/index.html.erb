<% content_for :title, "Store Apps - News Jace Pro" %>

<div class="mt-4">
  <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">ServiceNow Store Apps</h1>
      <p class="text-gray-600"><%= @apps.total_count %> applications</p>
    </div>

    <%= form_with url: applications_path, method: :get, class: "flex flex-wrap gap-2 items-center", local: true do |f| %>
      <%= f.text_field :search, value: @search, placeholder: "Search apps...",
          class: "rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-2 border text-sm w-48" %>
      <%= f.text_field :company, value: @company, placeholder: "Company...",
          class: "rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-2 border text-sm w-40" %>
      <%= f.select :app_type, options_for_select(ServicenowStoreApp.distinct.pluck(:app_type).compact.sort, @app_type),
          { include_blank: "All Types" },
          class: "rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-2 border text-sm" %>
      <%= f.select :price, options_for_select([['All Prices', ''], ['Free', 'free'], ['Paid', 'paid']], @price),
          {}, class: "rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-2 border text-sm" %>
      <%= f.select :sort, options_for_select([
        ['Most Popular', 'popular'],
        ['Most Installs', 'installs'],
        ['Title A-Z', 'title'],
        ['Company A-Z', 'company'],
        ['Newest Published', 'published'],
        ['Recently Updated', 'updated'],
        ['Most Reviews', 'reviews'],
        ['Most Tables', 'tables']
      ], @sort), {}, class: "rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-2 border text-sm" %>
      <%= f.select :direction, options_for_select([['Desc', 'desc'], ['Asc', 'asc']], @direction),
          {}, class: "rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-3 py-2 border text-sm w-20" %>
      <%= f.submit "Filter", class: "rounded-md bg-blue-600 px-4 py-2 text-white text-sm hover:bg-blue-700 cursor-pointer" %>
      <% if params.values_at(:search, :company, :app_type, :price, :trial, :no_license, :dev_instance, :prod_instance, :min_reviews, :published_within).any?(&:present?) || params[:sort].present? %>
        <%= link_to "Clear", applications_path, class: "rounded-md border border-gray-300 bg-white px-4 py-2 text-gray-700 text-sm hover:bg-gray-50" %>
      <% end %>
    <% end %>
  </div>

  <!-- Filter Panel -->
  <div class="mb-6 bg-gray-50 rounded-lg p-4 border">
    <h3 class="text-sm font-semibold text-gray-700 mb-3">Additional Filters</h3>
    <%= form_with url: applications_path, method: :get, class: "flex flex-wrap gap-4 items-end", local: true do |f| %>
      <!-- Preserve existing params -->
      <%= f.hidden_field :search, value: @search %>
      <%= f.hidden_field :company, value: @company %>
      <%= f.hidden_field :app_type, value: @app_type %>
      <%= f.hidden_field :price, value: @price %>
      <%= f.hidden_field :sort, value: @sort %>
      <%= f.hidden_field :direction, value: @direction %>

      <label class="flex items-center gap-2 cursor-pointer">
        <%= f.check_box :trial, { checked: @trial, class: "rounded border-gray-300 text-blue-600 focus:ring-blue-500" }, '1', nil %>
        <span class="text-sm text-gray-700">Trial Available</span>
      </label>

      <label class="flex items-center gap-2 cursor-pointer">
        <%= f.check_box :no_license, { checked: @no_license, class: "rounded border-gray-300 text-blue-600 focus:ring-blue-500" }, '1', nil %>
        <span class="text-sm text-gray-700">No License Required</span>
      </label>

      <label class="flex items-center gap-2 cursor-pointer">
        <%= f.check_box :dev_instance, { checked: @dev_instance, class: "rounded border-gray-300 text-blue-600 focus:ring-blue-500" }, '1', nil %>
        <span class="text-sm text-gray-700">Works on Dev Instance</span>
      </label>

      <label class="flex items-center gap-2 cursor-pointer">
        <%= f.check_box :prod_instance, { checked: @prod_instance, class: "rounded border-gray-300 text-blue-600 focus:ring-blue-500" }, '1', nil %>
        <span class="text-sm text-gray-700">Works on Prod Instance</span>
      </label>

      <div class="flex items-center gap-2">
        <%= f.label :min_reviews, "Min Reviews:", class: "text-sm text-gray-700" %>
        <%= f.number_field :min_reviews, value: @min_reviews, min: 0, placeholder: "0",
            class: "w-20 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-2 py-1 border text-sm" %>
      </div>

      <div class="flex items-center gap-2">
        <%= f.label :published_within, "Published within:", class: "text-sm text-gray-700" %>
        <%= f.select :published_within,
            options_for_select([['All Time', ''], ['30 days', 30], ['90 days', 90], ['180 days', 180]], @published_within),
            {}, class: "rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 px-2 py-1 border text-sm" %>
      </div>

      <%= f.submit "Apply", class: "rounded-md bg-blue-600 px-4 py-1.5 text-white text-sm hover:bg-blue-700 cursor-pointer" %>
    <% end %>
  </div>

  <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">
    <% @apps.each do |app| %>
      <%= link_to application_path(app), class: "rounded-lg border bg-white shadow-sm hover:shadow-md transition-shadow flex flex-col h-full group" do %>
        <div class="p-4 flex-1">
          <div class="flex items-start gap-3">
            <% if valid_logo_url?(app.logo) %>
              <img src="<%= app.logo %>" alt="<%= app.title %>"
                   class="h-12 w-12 rounded object-contain bg-gray-50"
                   onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
              <div class="h-12 w-12 rounded bg-slate-100 items-center justify-center text-lg font-bold text-slate-400 hidden">
                <%= app.title.first %>
              </div>
            <% else %>
              <div class="h-12 w-12 rounded bg-slate-100 flex items-center justify-center text-lg font-bold text-slate-400">
                <%= app.title.first %>
              </div>
            <% end %>

            <div class="flex-1 min-w-0">
              <h3 class="font-semibold text-gray-900 line-clamp-1 group-hover:text-blue-600"><%= app.title %></h3>
              <% if app.company_name.present? %>
                <span class="text-xs text-gray-500 truncate block"><%= app.company_name %></span>
              <% end %>
            </div>
          </div>

          <% if app.tagline.present? %>
            <p class="mt-2 text-sm text-gray-600 line-clamp-2"><%= app.tagline %></p>
          <% end %>

          <div class="mt-3 flex flex-wrap gap-2">
            <% if app.app_type.present? %>
              <span class="rounded bg-slate-100 px-1.5 py-0.5 text-xs text-slate-700"><%= app.app_type %></span>
            <% end %>
            <% if app.purchase_count.to_i > 0 %>
              <span class="rounded bg-green-100 px-1.5 py-0.5 text-xs text-green-700"><%= app.purchase_count %> installs</span>
            <% end %>
            <% if app.review_count.to_i > 0 %>
              <span class="rounded bg-yellow-100 px-1.5 py-0.5 text-xs text-yellow-700"><%= app.review_count %> reviews</span>
            <% end %>
          </div>

          <% if app.display_price.present? %>
            <p class="mt-2 text-sm font-semibold text-gray-900"><%= app.display_price %></p>
          <% end %>
        </div>

        <div class="border-t px-4 py-2 text-sm text-blue-600">
          View Details â†’
        </div>
      <% end %>
    <% end %>
  </div>

  <% if @apps.empty? %>
    <div class="text-center py-12">
      <p class="text-gray-500">No applications found</p>
    </div>
  <% end %>

  <div class="mt-6">
    <%= paginate @apps, params: request.query_parameters %>
  </div>
</div>

<script>
  // Submit filter forms when Enter is pressed in any input/select field
  document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('form[action="<%= applications_path %>"]');
    
    forms.forEach(form => {
      const inputs = form.querySelectorAll('input:not([type="submit"]), select');
      
      inputs.forEach(input => {
        input.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            form.submit();
          }
        });
      });
    });
  });
</script>
