<% content_for :title, "Edit Participant - Admin" %>

<div class="mb-6">
  <h1 class="text-2xl font-bold text-gray-900">Edit Participant</h1>
  <p class="text-gray-600"><%= @participant.name %></p>
</div>

<%= render "form", participant: @participant %>

<%# Merge Section %>
<div class="mt-8 bg-red-50 border border-red-200 rounded-lg p-6 max-w-2xl">
  <h2 class="text-lg font-medium text-red-900 mb-2">Merge Participant</h2>
  <p class="text-sm text-red-700 mb-4">
    Merge this participant into another one. This will delete <strong><%= @participant.name %></strong> 
    and transfer all their data (awards, sessions, news items) to the target participant.
  </p>
  
  <%= form_with url: merge_admin_participant_path(@participant), method: :get, class: "flex gap-2 items-end", local: true do |f| %>
    <div class="flex-1">
      <label class="block text-xs font-medium text-red-800 mb-1">Merge into participant</label>
      <div class="relative">
        <input type="text" 
               id="merge-participant-search" 
               placeholder="Type to search..." 
               autocomplete="off"
               class="block w-full rounded-md border-red-300 shadow-sm focus:border-red-500 focus:ring-red-500 text-sm">
        <%= f.hidden_field :target_id, id: "merge-target-id" %>
        <div id="merge-participant-results" class="hidden absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto"></div>
      </div>
    </div>
    <%= f.submit "Compare & Merge", class: "bg-red-600 text-white px-4 py-2 rounded text-sm hover:bg-red-700 cursor-pointer" %>
  <% end %>
</div>

<script>
(function() {
  const searchInput = document.getElementById('merge-participant-search');
  const resultsDiv = document.getElementById('merge-participant-results');
  const targetIdInput = document.getElementById('merge-target-id');
  let debounceTimer;
  
  searchInput.addEventListener('input', function() {
    const query = this.value.trim();
    targetIdInput.value = '';
    
    clearTimeout(debounceTimer);
    if (query.length < 2) {
      resultsDiv.classList.add('hidden');
      return;
    }
    
    debounceTimer = setTimeout(() => {
      fetch(`/api/participants/search?q=${encodeURIComponent(query)}&exclude=<%= @participant.id %>`)
        .then(r => r.json())
        .then(participants => {
          if (participants.length === 0) {
            resultsDiv.innerHTML = '<div class="px-3 py-2 text-sm text-gray-500">No matches found</div>';
          } else {
            resultsDiv.innerHTML = participants.map(p => 
              `<div class="px-3 py-2 text-sm hover:bg-red-50 cursor-pointer border-b border-gray-100 last:border-0" data-id="${p.id}" data-name="${p.name}">
                <div class="font-medium">${p.name}</div>
                <div class="text-xs text-gray-500">${p.title || 'No title'}${p.company ? ' â€¢ ' + p.company : ''}</div>
              </div>`
            ).join('');
          }
          resultsDiv.classList.remove('hidden');
        })
        .catch(err => {
          console.error('Search failed:', err);
          resultsDiv.innerHTML = '<div class="px-3 py-2 text-sm text-red-500">Search failed</div>';
          resultsDiv.classList.remove('hidden');
        });
    }, 200);
  });
  
  resultsDiv.addEventListener('click', function(e) {
    const item = e.target.closest('[data-id]');
    if (item) {
      searchInput.value = item.dataset.name;
      targetIdInput.value = item.dataset.id;
      resultsDiv.classList.add('hidden');
    }
  });
  
  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
      resultsDiv.classList.add('hidden');
    }
  });
  
  searchInput.addEventListener('focus', function() {
    if (resultsDiv.innerHTML && this.value.length >= 2) {
      resultsDiv.classList.remove('hidden');
    }
  });
})();
</script>
