<%= form_with model: [:admin, participant], class: "bg-white rounded-lg shadow p-6 max-w-2xl" do |f| %>
  <% if participant.errors.any? %>
    <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded">
      <ul class="list-disc list-inside text-red-600 text-sm">
        <% participant.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="space-y-4">
    <div>
      <%= f.label :name, class: "block text-sm font-medium text-gray-700" %>
      <%= f.text_field :name, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" %>
    </div>

    <div>
      <%= f.label :title, class: "block text-sm font-medium text-gray-700" %>
      <%= f.text_field :title, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm" %>
    </div>

    <%# Company linking section %>
    <div class="border rounded-lg p-4 <%= participant.company_id.nil? && participant.company_name.present? ? 'border-yellow-300 bg-yellow-50' : 'border-gray-200' %>">
      <div class="flex items-center justify-between mb-3">
        <label class="block text-sm font-medium text-gray-700">Company</label>
        <% if participant.company_id.nil? && participant.company_name.present? %>
          <span class="text-xs text-yellow-600 font-medium">⚠ Not linked</span>
        <% elsif participant.company_id.present? %>
          <span class="text-xs text-green-600 font-medium">✓ Linked</span>
        <% end %>
      </div>

      <div class="space-y-3">
        <%# Company name (text) %>
        <div>
          <%= f.label :company_name, "Company Name (text)", class: "block text-xs font-medium text-gray-500" %>
          <%= f.text_field :company_name, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm text-sm", placeholder: "e.g. Acme Corp" %>
          <p class="mt-1 text-xs text-gray-400">Display name - shown on profiles</p>
        </div>

        <%# Link to existing company with typeahead %>
        <div>
          <label class="block text-xs font-medium text-gray-500">Link to Company Record</label>
          <div class="relative mt-1">
            <input type="text" 
                   id="company-search" 
                   placeholder="Search companies..." 
                   value="<%= participant.company&.name %>"
                   autocomplete="off"
                   class="block w-full rounded-md border-gray-300 shadow-sm text-sm">
            <%= f.hidden_field :company_id, id: "company-id-input" %>
            <div id="company-results" class="hidden absolute z-10 mt-1 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto"></div>
          </div>
          <p class="mt-1 text-xs text-gray-400">Type to search, then select a company</p>
          <% if participant.company_id.present? %>
            <p class="mt-1 text-xs">
              Currently linked to: <%= link_to participant.company.name, admin_company_path(participant.company), class: "text-blue-600 hover:underline" %>
              <button type="button" onclick="document.getElementById('company-id-input').value=''; document.getElementById('company-search').value=''; this.parentElement.remove();" class="ml-2 text-red-600 hover:underline">Remove link</button>
            </p>
          <% end %>
        </div>

        <%# Quick create company option %>
        <% if participant.company_name.present? && participant.company_id.nil? %>
          <div class="pt-2 border-t border-yellow-200">
            <p class="text-xs text-gray-600 mb-2">Can't find the company?</p>
            <%= link_to new_admin_company_path(name: participant.company_name, return_to: request.path), 
                class: "inline-flex items-center gap-1 text-sm text-blue-600 hover:text-blue-800" do %>
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              Create "<%= participant.company_name %>" as a new company
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <div>
      <%= f.label :bio, class: "block text-sm font-medium text-gray-700" %>
      <%= f.text_area :bio, rows: 4, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm" %>
    </div>

    <div>
      <%= f.label :image_url, class: "block text-sm font-medium text-gray-700" %>
      <%= f.url_field :image_url, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm" %>
    </div>

    <div>
      <%= f.label :linkedin_url, class: "block text-sm font-medium text-gray-700" %>
      <%= f.url_field :linkedin_url, class: "mt-1 block w-full rounded-md border-gray-300 shadow-sm" %>
    </div>

    <%# MVP Awards Section %>
    <div class="border-t border-gray-200 pt-6 mt-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-900">MVP Awards</h3>
        <span class="text-sm text-gray-500"><%= participant.mvp_awards.count %> awards</span>
      </div>
      
      <% if participant.mvp_awards.any? %>
        <div class="space-y-2 mb-4">
          <% participant.mvp_awards.recent_first.each do |award| %>
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <div class="flex items-center gap-3">
                <span class="text-sm font-medium text-gray-900"><%= award.year %></span>
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium <%= award.badge_color %>">
                  <%= award.award_type %>
                </span>
                <% if award.source_url.present? %>
                  <%= link_to award.source_url, target: "_blank", rel: "noopener", class: "text-blue-600 hover:underline text-xs" do %>
                    <svg class="h-3.5 w-3.5 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                    Source
                  <% end %>
                <% end %>
              </div>
              <%= link_to "Remove", admin_participant_mvp_award_path(participant, award), 
                  method: :delete, 
                  data: { confirm: "Are you sure?" },
                  class: "text-red-600 hover:text-red-800 text-sm" %>
            </div>
          <% end %>
        </div>
      <% end %>
      
      <%= link_to new_admin_participant_mvp_award_path(participant), class: "inline-flex items-center gap-1 text-sm text-blue-600 hover:text-blue-800" do %>
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
        Add MVP Award
      <% end %>
    </div>

    <%# Startup Founder Section %>
    <div class="border-t border-gray-200 pt-6 mt-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-gray-900">Startup Founder</h3>
        <span class="text-sm text-gray-500"><%= participant.startup_founders.count %> companies</span>
      </div>
      
      <% if participant.startup_founders.any? %>
        <div class="space-y-2 mb-4">
          <% participant.startup_founders.each do |founder| %>
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <div class="flex items-center gap-3">
                <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
                <span class="text-sm font-medium text-gray-900"><%= founder.company_name %></span>
                <% if founder.source_url.present? %>
                  <%= link_to founder.source_url, target: "_blank", rel: "noopener", class: "text-blue-600 hover:underline text-xs" do %>
                    <svg class="h-3.5 w-3.5 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                    </svg>
                    Source
                  <% end %>
                <% end %>
              </div>
              <%= link_to "Remove", admin_participant_startup_founder_path(participant, founder), 
                  method: :delete, 
                  data: { confirm: "Are you sure?" },
                  class: "text-red-600 hover:text-red-800 text-sm" %>
            </div>
          <% end %>
        </div>
      <% end %>
      
      <%= link_to new_admin_participant_startup_founder_path(participant), class: "inline-flex items-center gap-1 text-sm text-blue-600 hover:text-blue-800" do %>
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
        Add Startup Founder Record
      <% end %>
    </div>

    <div class="flex gap-4 pt-4">
      <%= f.submit class: "bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 cursor-pointer" %>
      <%= link_to "Cancel", admin_participants_path, class: "px-4 py-2 text-gray-600 hover:text-gray-900" %>
    </div>
  </div>
<% end %>

<script>
(function() {
  const searchInput = document.getElementById('company-search');
  const resultsDiv = document.getElementById('company-results');
  const companyIdInput = document.getElementById('company-id-input');
  let debounceTimer;
  
  searchInput.addEventListener('input', function() {
    const query = this.value.trim();
    companyIdInput.value = ''; // Clear selection when typing
    
    clearTimeout(debounceTimer);
    if (query.length < 2) {
      resultsDiv.classList.add('hidden');
      return;
    }
    
    debounceTimer = setTimeout(() => {
      fetch(`/api/companies/search?q=${encodeURIComponent(query)}`)
        .then(r => r.json())
        .then(companies => {
          if (companies.length === 0) {
            resultsDiv.innerHTML = '<div class="px-3 py-2 text-sm text-gray-500">No matches found</div>';
          } else {
            resultsDiv.innerHTML = companies.map(c => 
              `<div class="px-3 py-2 text-sm hover:bg-blue-50 cursor-pointer" data-id="${c.id}" data-name="${c.name}">${c.name}</div>`
            ).join('');
          }
          resultsDiv.classList.remove('hidden');
        });
    }, 200);
  });
  
  resultsDiv.addEventListener('click', function(e) {
    const item = e.target.closest('[data-id]');
    if (item) {
      searchInput.value = item.dataset.name;
      companyIdInput.value = item.dataset.id;
      resultsDiv.classList.add('hidden');
    }
  });
  
  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
      resultsDiv.classList.add('hidden');
    }
  });
  
  searchInput.addEventListener('focus', function() {
    if (resultsDiv.innerHTML && this.value.length >= 2) {
      resultsDiv.classList.remove('hidden');
    }
  });
})();
</script>
